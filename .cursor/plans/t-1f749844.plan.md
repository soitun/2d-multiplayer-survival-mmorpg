<!-- 1f749844-bf8b-40cd-9009-cd4232b1103f be8d2c62-e337-4434-86f7-f56ceb6d8c14 -->
# Tallow Headlamp Implementation

## Server-Side Changes

### 1. Player Table - Add Headlamp State ([server/src/lib.rs](server/src/lib.rs))

Add `is_headlamp_lit: bool` field to the Player struct (around line 568, after `is_flashlight_on`).

### 2. New Headlamp Module (server/src/headlamp.rs)

Create new module with `toggle_headlamp` reducer:

- Check player is not dead/knocked out
- Check player has "Headlamp" equipped in **Head armor slot** (via active_armor table)
- Toggle `is_headlamp_lit` state
- Emit toggle sound event

### 3. Update Module Imports ([server/src/lib.rs](server/src/lib.rs))

- Add `mod headlamp;`
- Add `pub use headlamp::toggle_headlamp;`

### 4. Durability System ([server/src/durability.rs](server/src/durability.rs))

Add headlamp durability handling:

```rust
pub const HEADLAMP_TOTAL_DURATION_SECS: f32 = 1800.0; // 30 minutes
pub const HEADLAMP_DURABILITY_LOSS_PER_TICK: f32 = MAX_DURABILITY / (HEADLAMP_TOTAL_DURATION_SECS / TORCH_DURABILITY_TICK_INTERVAL_SECS as f32);
```

Extend `process_torch_durability` to:

- Find players with `is_headlamp_lit = true`
- Check their head armor slot for Headlamp item
- Reduce durability on that inventory item
- Turn off headlamp when durability reaches 0

### 5. Update Headlamp Item Definition ([server/src/items_database/armor.rs](server/src/items_database/armor.rs))

Update crafting cost to:

```rust
.crafting_cost(vec![
    CostIngredient { item_name: "Tallow".to_string(), quantity: 20 },
    CostIngredient { item_name: "Cloth".to_string(), quantity: 10 },
    CostIngredient { item_name: "Animal Hide".to_string(), quantity: 5 },
    CostIngredient { item_name: "Plant Fiber".to_string(), quantity: 30 },
])
```

## Client-Side Changes

### 6. Light Rendering ([client/src/utils/renderers/lightRenderingUtils.ts](client/src/utils/renderers/lightRenderingUtils.ts))

Add `renderHeadlampLight` function:

- Fire-like warm light (similar to torch - golden/amber colors)
- Position at player center (representing head-mounted light)
- Radius similar to torch but slightly larger for "good coverage"
- Flickering effect for fire feel
- Check `player.isHeadlampLit` flag

### 7. GameCanvas Integration ([client/src/components/GameCanvas.tsx](client/src/components/GameCanvas.tsx))

- Import `renderHeadlampLight`
- Add headlamp light rendering in the light rendering section (near torch light rendering around line 3084)
- Check for `player.isHeadlampLit` and render for local player

### 8. Regenerate Client Bindings

After server changes, run: `spacetime generate --lang typescript --out-dir client/src/generated --project-path server`

### To-dos

- [ ] Add is_headlamp_lit field to Player struct in lib.rs
- [ ] Create headlamp.rs with toggle_headlamp reducer
- [ ] Add headlamp durability constants and processing to durability.rs
- [ ] Update Headlamp crafting cost in armor.rs
- [ ] Add renderHeadlampLight function in lightRenderingUtils.ts
- [ ] Integrate headlamp light rendering in GameCanvas.tsx