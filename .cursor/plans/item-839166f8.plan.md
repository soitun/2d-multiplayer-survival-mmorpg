<!-- 839166f8-1a42-4009-855e-1be5a8adc80a 4dbcf641-f374-440e-ad20-e77120f84985 -->
# Item Durability System

## Server-Side Implementation

### 1. Create New Durability Module

Create [`server/src/durability.rs`](server/src/durability.rs) with:

**Constants:**

- `MAX_DURABILITY: f32 = 100.0` - All items start with 100 durability
- `DURABILITY_LOSS_PERCENT: f32 = 2.0` - Lose 2% (2 points) per successful hit
- `TORCH_DURABILITY_TICK_INTERVAL_SECS: u64 = 5` - Check every 5 seconds
- `TORCH_TOTAL_DURATION_SECS: f32 = 900.0` - 15 minutes = 900 seconds

**Helper Functions:**

```rust
pub fn get_durability(item: &InventoryItem) -> Option<f32>  // Parse from item_data JSON
pub fn set_durability(item: &mut InventoryItem, durability: f32)  // Update item_data JSON
pub fn has_durability_system(item_def: &ItemDefinition) -> bool  // Check if item uses durability
pub fn is_item_broken(item: &InventoryItem) -> bool  // Returns true if durability <= 0
pub fn reduce_durability_on_hit(ctx, item_instance_id) -> Result<bool, String>  // Returns true if item broke
```

**Scheduler Table:**

```rust
#[spacetimedb::table(name = torch_durability_schedule, scheduled(process_torch_durability))]
pub struct TorchDurabilitySchedule { ... }
```

**Scheduled Reducer:**

`process_torch_durability` - Iterates all players, checks:

1. Player has `is_torch_lit == true` 
2. Player has torch equipped in ActiveEquipment
3. Equipped item is actually a torch

If all conditions met, reduces durability. When durability hits 0, extinguishes torch (`is_torch_lit = false`) and marks item broken.

### 2. Register Module in lib.rs

Add to [`server/src/lib.rs`](server/src/lib.rs):

```rust
mod durability;
```

Call `durability::init_torch_durability_schedule(ctx)` from `init_module`.

### 3. Hook Durability Reduction into Combat

Modify [`server/src/active_equipment.rs`](server/src/active_equipment.rs) `use_equipped_item`:

- After `process_attack` returns with `result.hit == true`, call `durability::reduce_durability_on_hit()`
- Add early check: if item has durability system AND `is_item_broken()`, return error "Item is broken and cannot be used"

### 4. Prevent Broken Items from Being Equipped

Modify `set_active_item_reducer` in [`server/src/active_equipment.rs`](server/src/active_equipment.rs):

- Check if item is broken before allowing equip, return error if so

### 5. Initialize Durability for New Items

Items start with full durability. When first used, if no durability data exists, initialize to `MAX_DURABILITY`.

---

## Client-Side Implementation

### 1. Create Durability Helper Utilities

Create [`client/src/utils/durabilityHelpers.ts`](client/src/utils/durabilityHelpers.ts):

```typescript
export function getDurability(item: InventoryItem): number | null
export function hasDurabilitySystem(itemDef: ItemDefinition): boolean
export function getDurabilityPercentage(item: InventoryItem): number  // Returns 0-1
export function isItemBroken(item: InventoryItem): boolean
```

Logic for `hasDurabilitySystem`:

- Return true if category is `Weapon`, `Tool`, `RangedWeapon`
- OR if item name is `Torch` or `Flashlight`

### 2. Add Durability Bar to Hotbar.tsx

Modify [`client/src/components/Hotbar.tsx`](client/src/components/Hotbar.tsx):

- Add durability bar indicator (GREEN, on RIGHT side) similar to water bar (blue, left side)
- Position: `right: '4px'` instead of `left: '4px'`
- Color: `rgba(50, 205, 50, 0.8)` (lime green)
- Add grayed-out overlay when `isItemBroken()` returns true

### 3. Add Durability Bar to InventoryUI.tsx

Modify [`client/src/components/InventoryUI.tsx`](client/src/components/InventoryUI.tsx):

- Add same durability bar to inventory slots
- Add tooltip stat showing durability percentage

### 4. Add Durability Bar to ExternalContainerUI.tsx

Modify [`client/src/components/ExternalContainerUI.tsx`](client/src/components/ExternalContainerUI.tsx):

- Add durability bar to container slot items

---

## Data Storage Format

Durability stored in `item_data` JSON alongside water content:

```json
{"durability": 85.5}
// Or combined with water:
{"water_liters": 1.5, "durability": 100.0}
```

## Items Affected

- **Weapons:** Stone Knife, Wooden Spear, Stone Spear, Bone Club, Stone Machete, etc.
- **Tools:** Stone Hatchet, Stone Pickaxe, Metal Hatchet, Metal Pickaxe, Flint Hatchet, etc.
- **Ranged:** Hunting Bow, Crossbow, Makarov PM
- **Torches:** Torch (loses durability while lit via scheduler)
- **Flashlight:** Flashlight (loses durability while on via scheduler)