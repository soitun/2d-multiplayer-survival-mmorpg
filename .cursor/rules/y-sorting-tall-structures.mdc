---
description: Tall-structure Y-sorting guidance for current client pipeline
alwaysApply: false
---
# Y-Sorting for Tall Structures

Use this when players appear incorrectly in front of/behind tall entities (ALK stations, shelters, monuments, compound buildings).

## Current Architecture (Important)

- Y-sorting is centralized in `client/src/hooks/useEntityFiltering.ts`.
- `GameCanvas.tsx` consumes `ySortedEntities` from the hook and should not contain duplicate tall-structure sort rules.
- `client/src/utils/entityVisualConfig.ts` stores visual/collision interaction bounds; keep these conceptually aligned with Y-sort thresholds.
- `client/src/utils/entityFilteringUtils.ts` handles viewport filtering, not Y-sort ordering.

## Where to Edit

1. `client/src/hooks/useEntityFiltering.ts`
   - Base Y key logic in `getEntityY(...)` (for example, ALK `worldPosY - visualFootOffset`).
   - Special pairwise rules in `allEntities.sort(...)` (for example, player-like vs tall structure).

2. `client/src/utils/entityVisualConfig.ts`
   - Check visual/collision offsets (`centerOffsetY`, dimensions) for consistency with Y-sort intent.
   - If visual config shifts significantly, re-validate corresponding Y-sort constants in `useEntityFiltering.ts`.

## ALK Station Pattern

Use one consistent threshold across:

- ALK base sort key (`getEntityY`)
- ALK player-vs-structure comparator (`allEntities.sort`)

Example pattern:

```typescript
const ALK_STATION_VISUAL_FOOT_OFFSET = 170;
const sortY = station.worldPosY - ALK_STATION_VISUAL_FOOT_OFFSET;
```

This keeps "player in front when at/south of visual base" behavior stable.

## Debugging Checklist

- [ ] Reproduce from all directions (N/S/E/W), especially from south.
- [ ] Confirm `getEntityY(...)` for the tall entity uses a visual-foot-aware value.
- [ ] Confirm player-vs-entity special-case comparator exists in `allEntities.sort(...)`.
- [ ] Ensure player-like variants (swimming halves, etc.) follow same threshold policy.
- [ ] Verify `entityVisualConfig.ts` offsets still match intended visual/collision center.
- [ ] Do not add duplicate sort overrides in `GameCanvas.tsx`.

## Common Failure Modes

- Using raw `worldPosY` for tall sprites with transparent top area.
- Changing visual/collision offsets without revisiting Y-sort thresholds.
- Inconsistent constants between base sort key and pairwise comparator.
