# Docker Compose for LOCAL DEVELOPMENT only
# Does NOT affect Railway deployments (Railway uses per-service configs: railway.toml, Dockerfile in service dirs)
#
# Quick start:
#   1. Create .env from .env.example and add API keys for server-side procedures
#   2. docker compose up --build
#
# After starting:
#   2. Deploy database (one-time or after server changes): cd server && spacetime publish --project-path . broth-bullets-local && spacetime generate --lang typescript --out-dir ../client/src/generated --project-path .
#   3. Open http://localhost:3008

services:
  spacetimedb:
    image: clockworklabs/spacetime:latest
    command: start
    ports:
      - "3000:3000"
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000" ]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s

  auth-server:
    build:
      context: ./auth-server-openauth
      dockerfile: Dockerfile.dev
    ports:
      - "4001:4001"
    environment:
      PORT: 4001
      ISSUER_URL: http://localhost:4001
      NODE_ENV: development
    depends_on:
      spacetimedb:
        condition: service_healthy

  client:
    build:
      context: .
      dockerfile: Dockerfile.dev
    ports:
      - "3008:3008"
    environment:
      VITE_KOKORO_BASE_URL: http://localhost:8001
    volumes:
      - .:/app
      - /app/node_modules
    depends_on:
      - auth-server
    stdin_open: true
    tty: true

  tts-backend:
    build:
      context: ./tts-backend
      dockerfile: Dockerfile
    ports:
      - "8001:8001"
    environment:
      PORT: 8001
    depends_on:
      - auth-server
